<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title i18n-text="settingsTitle">Foxlate Settings</title>
    <link rel="stylesheet" href="options.css">
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="/icons/icon-48.png" alt="Logo" class="sidebar-logo">
                <span class="sidebar-title">Foxlate</span>
            </div>
            <nav id="settings-nav">
                <ul>
                    <li><a href="#general" class="nav-link active"><span class="nav-text" i18n-text="navGeneral">General</span></a></li>
                    <li><a href="#engine" class="nav-link"><span class="nav-text" i18n-text="navEngine">Engine</span></a></li>
                    <li><a href="#input-translation" class="nav-link"><span class="nav-text" i18n-text="navInputTranslation">Input</span></a></li>
                    <li><a href="#rules" class="nav-link"><span class="nav-text" i18n-text="navRules">Rules</span></a></li>
                    <li><a href="#cache" class="nav-link"><span class="nav-text" i18n-text="navCache">Cache</span></a></li>
                    <li><a href="#data" class="nav-link"><span class="nav-text" i18n-text="navData">Data</span></a></li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main id="settings-content" class="main-content">
            <!-- General -->
            <section id="general" class="content-panel active">
                <h2 i18n-text="generalSettings" class="section-title">General Settings</h2>
                <div class="card">
                    <div class="input-group">
                        <label class="input-label" for="targetLanguage" i18n-text="targetLanguage">Target Language</label>
                        <select id="targetLanguage" class="form-control"></select>
                    </div>
                    <div class="input-group">
                        <label class="input-label" for="displayModeSelect" i18n-text="displayMode">Display Mode</label>
                        <select id="displayModeSelect" class="form-control"></select>
                    </div>
                </div>
            </section>

            <!-- Engine -->
            <section id="engine" class="content-panel">
                <h2 i18n-text="engineSettings" class="section-title">Engine Settings</h2>
                <div class="card">
                    <div class="input-group">
                        <label class="input-label" for="translatorEngine" i18n-text="translationEngine">Translation Engine</label>
                        <select id="translatorEngine" class="form-control"></select>
                    </div>
                    
                    <div id="aiEngineManagementGroup" class="mt-2">
                        <button id="manageAiEnginesBtn" class="btn btn-secondary btn-full" i18n-text="aiEngineProfiles">Manage AI Profiles</button>
                    </div>

                    <div id="defaultEngineWarning" class="alert alert-error mt-2" style="display: none;"></div>

                    <div id="deeplxUrlGroup" class="input-group mt-2">
                        <label class="input-label" i18n-text="deeplxApiUrl">DeepLx API URL</label>
                        <input type="text" id="deeplxApiUrl" class="form-control" placeholder="https://api.deeplx.org/translate">
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header">
                        <h3 class="card-title" i18n-text="test">Test Translation</h3>
                    </div>
                    <div class="input-group">
                        <textarea id="test-source-text" class="form-control" rows="3" i18n-placeholder="testSourcePlaceholder"></textarea>
                    </div>
                    <div class="flex-row">
                        <button id="manual-test-translate-btn" class="btn btn-primary" i18n-text="translateButtonText">Translate</button>
                        <button id="toggleLogBtn" class="btn btn-text" i18n-text="testLogButton">Show Log</button>
                    </div>
                    <div id="test-result-area" class="alert mt-2" style="display:none;"></div>
                    <pre id="log-content" class="log-box mt-2" style="display:none;"></pre>
                </div>
            </section>

            <!-- Rules -->
            <section id="rules" class="content-panel">
                <h2 i18n-text="ruleManagement" class="section-title">Rule Management</h2>
                <div class="card">
                    <div class="input-group">
                        <label class="input-label" i18n-text="contentSelectorLabel">Global Content Selector</label>
                        <textarea id="defaultContentSelector" class="form-control" rows="3"></textarea>
                        <div class="text-error"></div>
                    </div>
                    <div class="input-group">
                        <label class="input-label" i18n-text="excludeSelectorsLabel">Global Exclude Selector</label>
                        <textarea id="defaultExcludeSelector" class="form-control" rows="2"></textarea>
                        <div class="text-error"></div>
                    </div>
                </div>

                <div class="flex-between mt-4 mb-2">
                    <h3 class="card-title" i18n-text="domainSpecificRules">Domain Rules</h3>
                    <button id="addDomainRuleBtn" class="btn btn-primary btn-sm" i18n-text="addDomainRule">Add Rule</button>
                </div>
                <ul id="domainRulesList" class="item-list"></ul>
            </section>

            <!-- Cache -->
            <section id="cache" class="content-panel">
                <h2 i18n-text="cacheManagement" class="section-title">Cache</h2>
                <div class="card">
                    <div class="input-group">
                        <label class="input-label" i18n-text="cacheSizeLabel">Max Cache Size</label>
                        <input type="number" id="cacheSizeInput" class="form-control" min="0" step="100">
                    </div>
                    <div class="flex-between mt-2">
                        <span class="text-sm text-muted"><span i18n-text="currentCacheUsage">Usage:</span> <span id="cacheInfoDisplay">...</span></span>
                        <button id="clearCacheBtn" class="btn btn-danger btn-sm" i18n-text="clearCache">Clear</button>
                    </div>
                </div>
            </section>

            <!-- Data -->
            <section id="data" class="content-panel">
                <h2 i18n-text="dataManagement" class="section-title">Data</h2>
                <div class="card">
                    <div class="flex-between mb-4">
                        <span class="input-label" i18n-text="enableCloudSync">Cloud Sync</span>
                        <label class="switch">
                            <input type="checkbox" id="syncEnabled">
                            <span class="switch-track"><span class="switch-thumb"></span></span>
                        </label>
                    </div>
                    
                    <div id="syncManagementControls" style="display: none;">
                        <div class="input-group mb-4">
                            <span id="cloudSettingsInfo" class="text-sm text-muted"></span>
                        </div>
                        <button id="uploadSettingsBtn" class="btn btn-secondary btn-full mb-4" i18n-text="uploadSettings">Upload Now</button>
                        <div class="flex-between mb-2">
                            <h4 class="text-sm font-semibold" i18n-text="cloudBackups">Backups</h4>
                            <button id="refreshCloudDataBtn" class="btn btn-text btn-sm" i18n-text="refreshCloudData">Refresh</button>
                        </div>
                        <ul id="cloudDataList" class="item-list"></ul>
                    </div>

                    <div class="divider"></div>
                    
                    <div class="grid-2">
                        <button id="export-btn" class="btn btn-secondary" i18n-text="exportSettings">Export</button>
                        <button id="import-btn" class="btn btn-secondary" i18n-text="importSettings">Import</button>
                    </div>
                    <input type="file" id="import-input" hidden>
                    <button id="reset-settings-btn" class="btn btn-text text-error mt-2 btn-full" i18n-text="resetSettings">Reset All Settings</button>
                </div>
            </section>
            
             <!-- Input Translation -->
            <section id="input-translation" class="content-panel">
                <h2 i18n-text="inputTranslationSettings" class="section-title">Input Translation</h2>
                <div class="card">
                     <div class="flex-between mb-4">
                        <span class="input-label" i18n-text="inputTranslationEnableLabel">Enable Feature</span>
                        <label class="switch">
                            <input type="checkbox" id="inputTranslationEnabled">
                            <span class="switch-track"><span class="switch-thumb"></span></span>
                        </label>
                    </div>
                    <div class="grid-2 mb-4">
                         <div class="input-group">
                            <label class="input-label" i18n-text="targetLanguage">Target</label>
                            <select id="inputTargetLanguage" class="form-control"></select>
                        </div>
                        <div class="input-group">
                            <label class="input-label" i18n-text="translationEngine">Engine</label>
                            <select id="inputTranslatorEngine" class="form-control"></select>
                        </div>
                    </div>

                    <div class="input-group mb-4">
                        <label class="input-label" i18n-text="inputTriggerWordLabel">Magic Word</label>
                        <input type="text" id="inputTriggerWord" class="form-control" placeholder="fox">
                        <div class="text-sm text-muted mt-2" i18n-text="inputTriggerWordDescription">Type text followed by "//[lang-]" + Magic Word</div>
                    </div>

                    <div class="divider"></div>

                    <div class="flex-between mb-4 mt-4">
                        <span class="input-label" i18n-text="inputKeyTriggerEnableLabel">Key-press Trigger</span>
                        <label class="switch">
                            <input type="checkbox" id="inputKeyTriggerEnabled">
                            <span class="switch-track"><span class="switch-thumb"></span></span>
                        </label>
                    </div>

                    <div class="grid-2 mb-4">
                        <div class="input-group">
                            <label class="input-label" i18n-text="inputConsecutiveKeyLabel">Trigger Key</label>
                            <input type="text" id="inputConsecutiveKey" class="form-control" placeholder="ControlLeft">
                        </div>
                        <div class="input-group">
                            <label class="input-label" i18n-text="inputConsecutiveKeyPressesLabel">Presses</label>
                            <input type="number" id="inputConsecutiveKeyPresses" class="form-control" min="2" max="5">
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="input-label" i18n-text="inputBlacklistLabel">Blacklist Domains</label>
                        <textarea id="inputBlacklist" class="form-control" rows="3" placeholder="example.com"></textarea>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Floating Save Button -->
    <button id="saveSettingsBtn" class="toast btn-primary">
        <span i18n-text="saveSettings">Save Changes</span>
    </button>
    <div id="statusMessage" class="toast"></div>

    <!-- Modals -->
    <div id="confirmModal" class="modal-backdrop">
        <div class="modal-content">
            <h3 id="confirmModalTitle" class="card-title">Confirm</h3>
            <p id="confirmModalMessage" class="text-sm text-muted mt-2 mb-4"></p>
            <div class="flex-between">
                <button id="confirmModalCancelBtn" class="btn btn-text" i18n-text="cancel">Cancel</button>
                <button id="confirmModalConfirmBtn" class="btn btn-primary" i18n-text="confirm">Confirm</button>
            </div>
        </div>
    </div>

    <!-- AI Engine Modal -->
    <div id="aiEngineModal" class="modal-backdrop">
        <div class="modal-content" style="max-width: 600px;">
            <div class="flex-between mb-4">
                <h3 i18n-text="aiEngineProfiles" class="card-title">AI Engines</h3>
                <button class="btn btn-icon close-button">✕</button>
            </div>
            
            <div id="aiEngineList" class="item-list mb-4"></div>
            <div class="grid-2">
                <button id="addAiEngineBtn" class="btn btn-secondary btn-full" i18n-text="addAiEngine">+ Add Engine</button>
                <button id="openImportAiEngineModalBtn" class="btn btn-text btn-full" i18n-text="importAiEngine">Import</button>
            </div>

            <!-- Edit Form (Hidden by default) -->
            <div id="aiEngineForm" class="mt-4 pt-4 border-t" style="display:none;">
                <h4 id="aiFormTitle" class="text-sm font-bold mb-2">Edit Engine</h4>
                <div class="input-group">
                    <label class="input-label" i18n-text="aiEngineName">Name</label>
                    <input type="text" id="aiEngineName" class="form-control">
                </div>
                <div class="input-group">
                    <label class="input-label" i18n-text="aiApiKey">API Key</label>
                    <input type="password" id="aiApiKey" class="form-control">
                </div>
                <div class="input-group">
                    <label class="input-label" i18n-text="aiApiUrl">API URL</label>
                    <input type="text" id="aiApiUrl" class="form-control">
                </div>
                <div class="input-group">
                    <label class="input-label" i18n-text="aiModelName">Model Name</label>
                    <input type="text" id="aiModelName" class="form-control">
                </div>
                <div class="input-group">
                    <label class="input-label" i18n-text="aiCustomPrompt">Custom Prompt</label>
                    <textarea id="aiCustomPrompt" class="form-control" rows="3"></textarea>
                    <span id="aiCustomPromptError" class="text-error"></span>
                    <button id="promptHelpBtn" class="btn btn-text btn-sm" i18n-text="viewPromptExamples">Examples</button>
                    <div id="promptPlaceholderHelp" class="mt-2 text-sm" style="display:none;">
                        <p class="text-muted">Available: {targetLang}, {sourceLang}, {context}</p>
                    </div>
                </div>
                
                <div class="grid-2 mt-2">
                    <div class="input-group">
                        <label class="input-label" i18n-text="aiShortTextThreshold">Threshold</label>
                        <input type="number" id="aiShortTextThreshold" class="form-control" min="0">
                    </div>
                    <div class="input-group">
                        <label class="input-label" i18n-text="aiShortTextEngine">Fallback</label>
                        <select id="aiShortTextEngine" class="form-control"></select>
                    </div>
                </div>

                <div id="aiTestSection" class="mt-4" style="display:none;">
                    <div class="input-group">
                        <label class="input-label" i18n-text="testOriginal">Test Text</label>
                        <textarea id="aiTestText" class="form-control" rows="2"></textarea>
                    </div>
                    <div id="aiTestResult" class="alert mt-2" style="display:none;"></div>
                </div>

                 <div class="grid-2 mt-4">
                    <button id="testAiEngineBtn" class="btn btn-secondary" i18n-text="test">Test</button>
                    <div class="flex-row" style="justify-content: flex-end;">
                        <button id="cancelAiEngineBtn" class="btn btn-text" i18n-text="cancel">Cancel</button>
                        <button id="saveAiEngineBtn" class="btn btn-primary" i18n-text="saveAiEngine">Save</button>
                    </div>
                 </div>
            </div>
        </div>
    </div>

    <!-- Import AI Engine Modal -->
    <div id="importAiEngineModal" class="modal-backdrop">
        <div class="modal-content" style="max-width: 500px;">
            <div class="flex-between mb-4">
                <h3 i18n-text="importAiEngineModalTitle" class="card-title">Import Engine</h3>
                <button class="btn btn-icon close-button">✕</button>
            </div>
            <div class="input-group">
                <label class="input-label" i18n-text="pasteAiEngineConfigLabel">Config JSON</label>
                <textarea id="importAiEngineConfigText" class="form-control" rows="6"></textarea>
                <div id="importAiEngineErrorText" class="text-error"></div>
            </div>
            <div class="flex-between mt-4">
                <button id="cancelImportAiEngineBtn" class="btn btn-text" i18n-text="cancel">Cancel</button>
                <button id="confirmImportAiEngineBtn" class="btn btn-primary" i18n-text="confirmImport">Import</button>
            </div>
        </div>
    </div>

    <!-- Domain Rule Modal -->
    <div id="domainRuleModal" class="modal-backdrop">
        <div class="modal-content" style="max-width: 600px;">
            <h3 id="domainRuleFormTitle" class="card-title mb-4">Domain Rule</h3>
            <div id="domainRuleForm">
                <input type="hidden" id="editingDomain">
                <div class="input-group">
                    <label class="input-label" i18n-text="domain">Domain</label>
                    <input type="text" id="ruleDomain" class="form-control" placeholder="example.com">
                </div>

                <div class="flex-row mt-2">
                    <label class="switch">
                        <input type="checkbox" id="ruleApplyToSubdomains">
                        <span class="switch-track"><span class="switch-thumb"></span></span>
                    </label>
                    <span class="text-sm" i18n-text="applyToSubdomains">Apply to subdomains</span>
                </div>
                
                <div class="grid-2 mt-2">
                    <div class="input-group">
                        <label class="input-label" i18n-text="autoTranslate">Auto Translate</label>
                        <select id="ruleAutoTranslate" class="form-control"></select>
                    </div>
                    <div class="input-group">
                        <label class="input-label" i18n-text="translationEngine">Engine</label>
                        <select id="ruleTranslatorEngine" class="form-control"></select>
                    </div>
                </div>

                <div class="grid-2 mt-2">
                    <div class="input-group">
                        <label class="input-label" i18n-text="popupSourceLanguage">Source</label>
                        <select id="ruleSourceLanguage" class="form-control"></select>
                    </div>
                    <div class="input-group">
                        <label class="input-label" i18n-text="targetLanguage">Target</label>
                        <select id="ruleTargetLanguage" class="form-control"></select>
                    </div>
                </div>

                <div class="grid-2 mt-2">
                    <div class="input-group">
                        <label class="input-label" i18n-text="displayMode">Display Mode</label>
                        <select id="ruleDisplayMode" class="form-control"></select>
                    </div>
                </div>

                <div class="card mt-4 p-4 border bg-gray-50">
                    <div class="input-group">
                        <label class="input-label" i18n-text="contentSelectorLabel">Content Selector</label>
                        <textarea id="ruleContentSelector" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="input-group mt-2">
                        <label class="input-label" i18n-text="excludeSelectorsLabel">Exclude Selector</label>
                        <textarea id="ruleExcludeSelector" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="flex-row mt-2">
                        <label class="switch">
                            <input type="checkbox" id="ruleCssSelectorOverride">
                            <span class="switch-track" style="width: 24px; height: 14px;"><span class="switch-thumb" style="width: 10px; height: 10px;"></span></span>
                        </label>
                        <span class="text-sm" i18n-text="overrideDefaultSelectors">Override Global</span>
                    </div>
                </div>

                <!-- Subtitle Settings -->
                <div class="divider"></div>
                <div class="flex-between mb-2">
                    <span class="input-label" i18n-text="enableSubtitleTranslation">Subtitle Translation</span>
                    <label class="switch">
                        <input type="checkbox" id="ruleEnableSubtitle">
                        <span class="switch-track"><span class="switch-thumb"></span></span>
                    </label>
                </div>
                <div id="ruleSubtitleSettingsGroup" class="grid-2" style="display:none;">
                    <div class="input-group">
                        <label class="input-label" i18n-text="subtitleStrategy">Strategy</label>
                        <select id="ruleSubtitleStrategy" class="form-control"></select>
                    </div>
                    <div class="input-group">
                        <label class="input-label" i18n-text="subtitleDisplayMode">Display</label>
                        <select id="ruleSubtitleDisplayMode" class="form-control"></select>
                    </div>
                </div>

                <!-- Summary Settings -->
                <div class="divider"></div>
                <div class="flex-between mb-2">
                    <span class="input-label" i18n-text="enableContentSummary">Content Summary</span>
                    <label class="switch">
                        <input type="checkbox" id="ruleEnableSummary">
                        <span class="switch-track"><span class="switch-thumb"></span></span>
                    </label>
                </div>
                <div id="ruleSummarySettingsGroup" style="display:none;">
                    <div class="input-group">
                        <label class="input-label" i18n-text="summaryAiModelLabel">AI Model</label>
                        <select id="ruleSummaryAiModel" class="form-control"></select>
                    </div>
                    <div class="input-group mt-2">
                        <label class="input-label" i18n-text="mainBodySelectorLabel">Main Body Selector</label>
                        <textarea id="ruleMainBodySelector" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                
                <div class="flex-between mt-6">
                    <button id="cancelDomainRuleBtn" class="btn btn-text" i18n-text="cancel">Cancel</button>
                    <button id="saveDomainRuleBtn" class="btn btn-primary" i18n-text="saveRule">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script src="options.js" type="module"></script>
</body>
</html>