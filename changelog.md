# Changelog

## [1.3.0] - 2025-10-09

### ✨ Features
*   **内容摘要 (Content Summary):**
    *   引入 AI 对话式内容摘要功能 (MD3 风格)
    *   支持流式渲染和 Markdown 格式
    *   可拖拽、可调整大小的对话框
    *   支持对话历史记录、编辑和刷新
*   **设置云同步 (Settings Cloud Sync):**
    *   增加设置的云端备份与恢复功能
*   **UI/UX 改进:**
    *   设置页面增加导航菜单
    *   重构设置页面 UI，使用 Lit Web Components
    *   重新设计摘要按钮为 FAB (浮动操作按钮) 风格
    *   统一加载和翻译状态的徽章颜色

### ♻️ Refactors
*   **状态管理 (State Management):**
    *   在选项和弹出页面中实现基于 Reducer 模式的统一状态管理
    *   重构 `TabStateManager` 以简化状态管理
*   **代码结构 (Code Structure):**
    *   将 AI 任务处理移至 `TranslatorManager`
    *   将摘要功能重构为独立的模块
    *   统一设置管理和同步逻辑
*   **DOM 操作:**
    *   使用 Readability 优化内容提取
    *   优化注入脚本和可见性检查的性能

### 🐛 Fixes
*   支持`<iframe>`内的文本选择翻译
*   修复了摘要对话框的按钮定位和拖动问题

## [1.2.2] - 2025-09-28

本次更新主要围绕 **AI 总结与对话功能** 进行了大量增强、优化和缺陷修复。核心改进包括：

- **AI 总结与对话功能全面升级**：引入了消息增量渲染、编辑、历史记录管理、会话操作及动态定位算法，显著提升了用户交互体验。
- **AI 引擎与设置优化**：增强了 AI 引擎的云同步和状态跟踪，并改进了相关设置的验证和自动配置。
- **用户界面与体验改进**：优化了对话框动画、按钮定位逻辑，并修复了多项与总结功能相关的界面显示和交互问题。
- **构建与文档更新**：更新了 Readability 库版本，并完善了 README 和文档内容。

## [1.2.1] - 2025-07-30

本次更新是一次维护性版本，专注于性能优化和缺陷修复，提升了扩展在处理动态内容时的稳定性和效率。

### 🚀 优化与重构 (Optimizations & Refactoring)

- **内容脚本性能优化**:
  - 优化了 DOM 变化监听中的节点可见性检查逻辑，按照成本递增顺序进行检查，减少不必要的重排操作
  - 改进了动态内容处理机制，使用防抖和空闲回调相结合的方式处理新增节点
  - 优化了 Shadow DOM 遍历逻辑，提升复杂页面结构的处理效率
- **后台性能优化**:
  - 实现了缓存防抖机制，减少不必要的缓存操作
  - 优化了 DOM 操作，提升后台处理效率
- **预检查逻辑优化**:
  - 优化了黑名单规则处理，提高规则匹配的准确性
  - 改进了擦除函数性能，使用合并的黑名单规则进行处理

### 🐞 缺陷修复 (Bug Fixes)

- **内容处理修复**:
  - 彻底清理生成的包裹器元素，避免内存泄漏
  - 移除了内容脚本中未使用的 mutationObserver 变量
- **弹窗优化**:
  - 移除了弹窗中冗余的设置获取调用，提升响应速度

## [1.2.0] - 2025-07-26

本次更新聚焦于内部架构的深度重构和性能的显著优化，旨在提升扩展的稳定性、响应速度和在复杂网页上的翻译可靠性。

### 🚀 优化与重构 (Optimizations & Refactoring)

- **核心翻译流程优化**:
  - **DOMWalker 性能提升**: 完全重构了元素可见性检查逻辑，采用分层策略（从低成本到高成本检查），并优化了预检查序列，从而在遍历 DOM 时能更快地排除不应翻译的元素，显著提升了在复杂页面上的性能。
  - **非阻塞式翻译**: 内容脚本现在通过 `requestIdleCallback` API 来调度元素查找和翻译任务，减少了对页面主线程的阻塞，使网页滚动和交互更加流畅。
  - **DOM 重建器增强**: `DOMReconstructor` 被重构为一个健壮的类，增加了对标签嵌套的严格验证和错误处理，提高了格式保留翻译的可靠性。
- **后台架构现代化**:
  - 引入了 `TabStateManager` 来集中管理所有标签页的翻译状态，使后台逻辑更清晰、更可靠。
  - 移除了通过注入全局变量来传递 `tabId` 的旧方法，改为使用更健壮的消息传递机制。
- **代码质量与语义化**:
  - 使用 `<foxlate-wrapper>` 自定义元素替代了通用的 `<span>` 来包裹孤立文本，使 DOM 结构在语义上更清晰。
  - 统一了通过 `dataset` 属性来管理元素状态的方式，取代了零散的 CSS 类名切换。

### ✨ 新增功能 (Features)

- **更智能的元素识别**: `DOMWalker` 现在能够识别并跳过 `contenteditable`（可编辑）区域和通过 `aria-hidden="true"` 对辅助技术隐藏的元素，避免了对不应翻译内容的干扰。
- **增强的预检查规则**: 预检查逻辑得到增强，可以更准确地识别和过滤掉仅由表情符号（Emoji）或特殊标记组成的文本。

### 🐞 缺陷修复 (Bug Fixes)

- **修复孤立内容处理**: 改进了对“孤立”文本节点（即未被选择器直接命中的文本）的识别和包裹逻辑，确保在复杂的嵌套布局中也能完整、准确地翻译所有可见文本。

## [1.1.0] - 2025-07-22

本次更新是一次重大版本升级，引入了强大的排除选择器功能，重构了核心翻译逻辑，并对 AI 引擎管理、选项页面体验和整体性能进行了全面增强和优化。

### ✨ 新增功能 (Features)

- **排除选择器 (Exclude Selectors)**: 新增全局和域名级别的排除选择器，允许用户精确地跳过对特定元素（如代码块、导航栏）的翻译。
- **更智能的元素识别**: 完全重构了元素查找逻辑 (`findTranslatableElements`)，能够更精确地识别和处理复杂页面布局中的“孤立”文本节点，确保了翻译内容的完整性，不再遗漏 `<i>`, `<b>` 等内联格式化标签。
- **AI 引擎增强**:
  - 新增 AI 引擎配置的导入和复制功能，方便用户分享和备份。
  - AI 连接测试功能现在支持使用自定义文本进行测试，以获得更真实的测试结果。
- **选项页面体验优化**:
  - 弹窗（如域名规则、AI 引擎配置）在每次打开时会自动重置滚动条到顶部。
  - 规则和 AI 引擎的保存操作现在是原子化的，并提供了更清晰的错误处理。
  - 为字幕翻译设置添加了“禁用时保留设置”的选项，提升了用户体验。
- **加载指示器**: 实现了基于 SVG 遮罩的全新加载动画，并支持根据用户的系统偏好（`prefers-reduced-motion`）减少动态效果。
- **DOMWalker 增强**: `DOMWalker` 现在支持可配置的块级/行内元素类型判断，提高了翻译布局的准确性。
- **追加策略 (Append Strategy) 增强**: 优化了对块级元素的检测，使追加模式下的格式更可靠。
- **Popup 增强**: 在弹出窗口中添加了“关于”按钮，方便用户访问项目的 GitHub 仓库。

### 🚀 优化与重构 (Optimizations & Refactoring)

- **DOMWalker 性能优化**: 优化了 `DOMWalker` 的空白字符处理、元素排除匹配逻辑和节点克隆方式，提升了性能。
- **Google 翻译器**: 将 Google 翻译的 API 请求切换为 POST 方法，以支持更长的文本翻译。
- **代码质量提升**:
  - 统一了 `escapeHtml` 等工具函数，移除了多个文件中的重复实现。
  - 改进了弹窗的滚动行为和整体布局，并更新了追加文本的引用样式。

### 🐞 缺陷修复 (Bug Fixes)

- **修复重复翻译问题**: 彻底解决了在嵌套元素（如 `<td>` 内包含 `<p>`）中，`append` 策略会导致翻译内容被重复追加的严重缺陷。
- **修复动态内容处理**: 修复了 `MutationObserver` 无法正确忽略由脚本自身生成的包裹元素（`data-foxlate-generated`）的问题，减少了不必要的性能开销，并提高了在动态加载内容页面（如无限滚动）上的稳定性。
- **错误处理增强**: 优化了内容脚本中的消息处理机制，现在会返回结构化的错误信息，避免了在浏览器控制台中出现未捕获的 Promise 拒绝警告。
- **AI 翻译器**: 为缺失 API Key 的情况添加了本地化的错误提示。

### 📝 文档 (Documentation)

- 新增了此 `changelog.md` 文件，以记录未来的版本变更。
- 更新了 README 和 i18n 文本，以阐明新功能。

---
